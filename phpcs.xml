<?xml version="1.0" encoding="UTF-8"?>
<project default="phpcs">
    <description>
        PHP_CodeSniffer tokenizes PHP, JavaScript and CSS files to detect and fix violations of a defined set of coding standards.
    </description>

    <target name="phpcs">
        <!-- Define variables -->
        <property name="phpcs.config.path" value="${teamcity.build.checkoutDir}/phpcs.xml"/>
        <property name="phpcs.path" value="${teamcity.build.checkoutDir}/vendor/bin/phpcs"/>
        <property name="report.path" value="${teamcity.build.tempDir}/phpcs-report.xml"/>

        <!-- The [projectroot]/phpcs.xml configuration file should exist. -->
        <available file="${phpcs.config.path}" property="phpcs.config.present"/>
        <fail unless="phpcs.config.present" message="The '[projectroot]/phpcs.xml' configuration file doesn't exists."/>

        <!-- The phpcs executable should be available in the vendor folder (composer require-dev dependency). -->
        <available file="${phpcs.path}" property="phpcs.path.present"/>
        <fail unless="phpcs.path.present" message="The '${phpcs.path}' executable isn't available in your project."/>

        <!-- Run the PHP code sniffer -->
        <exec executable="${phpcs.path}" failonerror="false" dir="${teamcity.build.checkoutDir}">
            <arg line="-d memory_limit=512M"/>
            <arg line="--report=checkstyle"/>
            <arg line="--report-file=${report.path}"/>
        </exec>

        <echo message="##teamcity[importData type='checkstyle' path='${report.path}']"/>
    </target>
</project>
